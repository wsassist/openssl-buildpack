#!/usr/bin/env bash
set -e

BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"

OPENSSL_VERSION="3.3.4"
OPENSSL_URL="https://github.com/openssl/openssl/releases/download/openssl-${OPENSSL_VERSION}/openssl-${OPENSSL_VERSION}.tar.gz"
OPENSSL_INSTALL_DIR="$BUILD_DIR/.openssl"

echo "-----> Installing OpenSSL ${OPENSSL_VERSION}"

# Create directories
mkdir -p "$OPENSSL_INSTALL_DIR"

# Download and extract OpenSSL quietly
curl -sL "$OPENSSL_URL" | tar -xzf - -C /tmp

# Build OpenSSL quietly
cd "/tmp/openssl-${OPENSSL_VERSION}"
./config --prefix="$OPENSSL_INSTALL_DIR" --openssldir="$OPENSSL_INSTALL_DIR/ssl" no-shared > /dev/null
make -s -j"$(nproc)" > /dev/null
make install_sw > /dev/null

# Export paths for subsequent buildpacks
mkdir -p "$BUILD_DIR/.profile.d"
{
  echo "export PATH=\"$OPENSSL_INSTALL_DIR/bin:\$PATH\""
  echo "export LD_LIBRARY_PATH=\"$OPENSSL_INSTALL_DIR/lib:\$LD_LIBRARY_PATH\""
  echo "export LIBRARY_PATH=\"$OPENSSL_INSTALL_DIR/lib:\$LIBRARY_PATH\""
  echo "export CPATH=\"$OPENSSL_INSTALL_DIR/include:\$CPATH\""
  echo "export PKG_CONFIG_PATH=\"$OPENSSL_INSTALL_DIR/lib/pkgconfig:\$PKG_CONFIG_PATH\""
} > "$BUILD_DIR/.profile.d/openssl.sh"

echo "-----> OpenSSL ${OPENSSL_VERSION} installed"
